{"version":3,"file":"index.js","names":["useModal","getTranslation","useRouter","formatAdminURL","qs","React","useCallback","useMemo","toast","useForm","useFormModified","useConfig","useLocale","useRouteTransition","useTranslation","requests","traverseForLocalizedFields","ConfirmationModal","PopupList","SelectLocalesDrawer","DuplicateDocument","id","slug","onDuplicate","redirectAfterDuplicate","selectLocales","singularLabel","router","modified","openModal","code","localeCode","setModified","startRouteTransition","config","localization","routes","admin","adminRoute","api","apiRoute","serverURL","getEntityConfig","collectionConfig","collectionSlug","i18n","t","modalSlug","drawerSlug","isDuplicateByLocaleEnabled","fields","handleDuplicate","args","selectedLocales","hasSelectedLocales","length","queryParams","locale","headers","language","credentials","res","post","stringify","addQueryPrefix","body","JSON","doc","errors","message","json","status","success","label","push","path","error","_error","handleConfirmWithoutSaving","buttonLabel","_jsxs","Fragment","_jsx","Button","onClick","confirmLabel","heading","onConfirm"],"sources":["../../../src/elements/DuplicateDocument/index.tsx"],"sourcesContent":["'use client'\n\nimport type { SanitizedCollectionConfig } from 'payload'\n\nimport { useModal } from '@faceless-ui/modal'\nimport { getTranslation } from '@payloadcms/translations'\nimport { useRouter } from 'next/navigation.js'\nimport { formatAdminURL } from 'payload/shared'\nimport * as qs from 'qs-esm'\nimport React, { useCallback, useMemo } from 'react'\nimport { toast } from 'sonner'\n\nimport type { DocumentDrawerContextType } from '../DocumentDrawer/Provider.js'\n\nimport { useForm, useFormModified } from '../../forms/Form/context.js'\nimport { useConfig } from '../../providers/Config/index.js'\nimport { useLocale } from '../../providers/Locale/index.js'\nimport { useRouteTransition } from '../../providers/RouteTransition/index.js'\nimport { useTranslation } from '../../providers/Translation/index.js'\nimport { requests } from '../../utilities/api.js'\nimport { traverseForLocalizedFields } from '../../utilities/traverseForLocalizedFields.js'\nimport { ConfirmationModal } from '../ConfirmationModal/index.js'\nimport { PopupList } from '../Popup/index.js'\nimport { SelectLocalesDrawer } from './SelectLocalesDrawer/index.js'\n\nexport type Props = {\n  readonly id: number | string\n  readonly onDuplicate?: DocumentDrawerContextType['onDuplicate']\n  readonly redirectAfterDuplicate?: boolean\n  readonly selectLocales?: boolean\n  readonly singularLabel: SanitizedCollectionConfig['labels']['singular']\n  readonly slug: string\n}\n\nexport const DuplicateDocument: React.FC<Props> = ({\n  id,\n  slug,\n  onDuplicate,\n  redirectAfterDuplicate = true,\n  selectLocales,\n  singularLabel,\n}) => {\n  const router = useRouter()\n  const modified = useFormModified()\n  const { openModal } = useModal()\n  const { code: localeCode } = useLocale()\n  const { setModified } = useForm()\n  const { startRouteTransition } = useRouteTransition()\n\n  const {\n    config: {\n      localization,\n      routes: { admin: adminRoute, api: apiRoute },\n      serverURL,\n    },\n    getEntityConfig,\n  } = useConfig()\n\n  const collectionConfig = getEntityConfig({ collectionSlug: slug })\n\n  const { i18n, t } = useTranslation()\n\n  const modalSlug = `duplicate-${id}`\n  const drawerSlug = `duplicate-locales-${id}`\n\n  const isDuplicateByLocaleEnabled = useMemo(() => {\n    if (selectLocales && collectionConfig) {\n      return traverseForLocalizedFields(collectionConfig.fields)\n    }\n    return false\n  }, [collectionConfig, selectLocales])\n\n  const handleDuplicate = useCallback(\n    async (args?: { selectedLocales?: string[] }) => {\n      const { selectedLocales } = args || {}\n      const hasSelectedLocales = selectedLocales && selectedLocales.length > 0\n\n      const queryParams: Record<string, string | string[]> = {}\n      if (localeCode) {\n        queryParams.locale = localeCode\n      }\n      if (hasSelectedLocales) {\n        queryParams.selectedLocales = selectedLocales\n      }\n\n      const headers = {\n        'Accept-Language': i18n.language,\n        'Content-Type': 'application/json',\n        credentials: 'include',\n      }\n\n      try {\n        const res = await requests.post(\n          `${serverURL}${apiRoute}/${slug}/${id}/duplicate${qs.stringify(queryParams, {\n            addQueryPrefix: true,\n          })}`,\n          {\n            body: JSON.stringify({}),\n            headers,\n          },\n        )\n\n        const { doc, errors, message } = await res.json()\n\n        if (res.status < 400) {\n          toast.success(\n            message ||\n              t('general:successfullyDuplicated', { label: getTranslation(singularLabel, i18n) }),\n          )\n\n          setModified(false)\n\n          if (redirectAfterDuplicate) {\n            return startRouteTransition(() =>\n              router.push(\n                formatAdminURL({\n                  adminRoute,\n                  path: `/collections/${slug}/${doc.id}${localeCode ? `?locale=${localeCode}` : ''}`,\n                }),\n              ),\n            )\n          }\n\n          if (typeof onDuplicate === 'function') {\n            void onDuplicate({ collectionConfig, doc })\n          }\n        } else {\n          toast.error(\n            errors?.[0].message ||\n              message ||\n              t('error:unspecific', { label: getTranslation(singularLabel, i18n) }),\n          )\n        }\n      } catch (_error) {\n        toast.error(t('error:unspecific', { label: getTranslation(singularLabel, i18n) }))\n      }\n    },\n    [\n      adminRoute,\n      apiRoute,\n      collectionConfig,\n      i18n,\n      id,\n      localeCode,\n      onDuplicate,\n      redirectAfterDuplicate,\n      router,\n      serverURL,\n      setModified,\n      singularLabel,\n      slug,\n      startRouteTransition,\n      t,\n    ],\n  )\n\n  const handleConfirmWithoutSaving = useCallback(async () => {\n    if (selectLocales) {\n      openModal(drawerSlug)\n    } else {\n      await handleDuplicate()\n    }\n  }, [handleDuplicate, drawerSlug, selectLocales, openModal])\n\n  const buttonLabel = selectLocales\n    ? `${t('general:duplicate')} ${t('localization:selectedLocales')}`\n    : t('general:duplicate')\n\n  if (!selectLocales || isDuplicateByLocaleEnabled) {\n    return (\n      <React.Fragment>\n        <PopupList.Button\n          id={`action-duplicate${isDuplicateByLocaleEnabled ? `-locales` : ''}`}\n          onClick={() => {\n            if (modified) {\n              openModal(modalSlug)\n            } else if (selectLocales) {\n              openModal(drawerSlug)\n            } else {\n              void handleDuplicate()\n            }\n          }}\n        >\n          {buttonLabel}\n        </PopupList.Button>\n        <ConfirmationModal\n          body={t('general:unsavedChangesDuplicate')}\n          confirmLabel={t('general:duplicateWithoutSaving')}\n          heading={t('general:unsavedChanges')}\n          modalSlug={modalSlug}\n          onConfirm={handleConfirmWithoutSaving}\n        />\n        {selectLocales && localization && (\n          <SelectLocalesDrawer\n            localization={localization}\n            onConfirm={handleDuplicate}\n            slug={drawerSlug}\n          />\n        )}\n      </React.Fragment>\n    )\n  }\n\n  return null\n}\n"],"mappings":"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","ignoreList":[]}